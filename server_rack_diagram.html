<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rack Planner – Multi‑Rack + Presets (Single HTML)</title>
<style>
  :root{
    --unit: 22px;              /* pixels per 1U */
    --rackU: 42;               /* default rack height */
    --rack-width: 360px;       /* inner usable width for devices */
    --gutter: 56px;            /* space for U numbers */
    --bg: #0f1226;             /* page background */
    --panel: #171a33;          /* panel background */
    --line: #2a2f55;           /* grid line */
    --accent: #7aa2ff;         /* accent color */
    --bad: #ff5d5d;            /* bad red */
    --text: #e6e8ff;           /* text */
    --muted: #9aa3c7;          /* muted text */
  }
  html,body{height:100%}
  body{margin:0;background: radial-gradient(1200px 600px at 20% -10%, #1d2250, #0a0c1a), var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Arial;display:flex;flex-direction:column;gap:14px}
  header{padding:14px clamp(10px,3vw,24px);display:flex;flex-wrap:wrap;align-items:center;gap:10px 16px;background:rgba(255,255,255,.02);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
  h1{font-size:18px;margin:0 8px 0 0}
  .controls{display:flex;flex-wrap:wrap;gap:8px 12px;align-items:center}
  .group{display:flex;flex-wrap:wrap;align-items:center;gap:6px;background:var(--panel);border:1px solid rgba(255,255,255,.06);padding:8px 10px;border-radius:12px}
  label{color:var(--muted);font-size:12px}
  input[type="number"],input[type="text"],select{background:#0f1330;color:var(--text);border:1px solid #2a2f55;border-radius:8px;padding:6px 8px;outline:none;min-width:70px;font-size:13px}
  input[type="color"]{width:36px;height:28px;border:none;background:transparent;padding:0}
  button{background:linear-gradient(180deg,#3a56ff,#2a3ecf);border:none;color:#fff;padding:9px 11px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(58,86,255,.25)}
  button.secondary{background:#24284e;color:#cbd2ff;box-shadow:none;border:1px solid #2a2f55}
  button.danger{background:linear-gradient(180deg,#ff6b6b,#d94b4b)}
  button:disabled{opacity:.55;cursor:not-allowed}
  main{display:grid;grid-template-columns:1fr auto 1fr;align-items:start;gap:16px;padding:0 clamp(10px,2vw,24px) 24px}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px}
  .stack{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hr{height:1px;background:rgba(255,255,255,.08);margin:4px 0}
  .notice{font-size:12px;color:var(--muted)}

  /* Rack visuals */
  .racks-bar{display:flex;gap:8px;align-items:center}
  .rack-title{font-weight:700;padding:2px 8px;border:1px solid #2a2f55;border-radius:8px;background:#0f1330}

  .rack-wrap{position:relative;display:flex;gap:10px;align-items:flex-start}
  .u-scale{position:relative;height:calc(var(--unit)*var(--rackU));width:var(--gutter);color:var(--muted);font-size:11px;user-select:none}
  .u-scale .tick{position:absolute;left:0;right:0;height:var(--unit);display:flex;align-items:center;justify-content:flex-end;padding-right:8px}
  .rack{position:relative;height:calc(var(--unit)*var(--rackU));width:var(--rack-width);background:linear-gradient(180deg,#0e1330,#0a0e25);border:2px solid #2a2f55;border-radius:14px;box-shadow:inset 0 0 0 3px rgba(0,0,0,.35),0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .rack::before{content:"";position:absolute;inset:12px 10px;pointer-events:none;border:1px solid rgba(255,255,255,.06);border-radius:10px}
  .rack .grid{position:absolute;inset:16px 14px;background:repeating-linear-gradient(to bottom,rgba(255,255,255,.06) 0px,rgba(255,255,255,.06) 1px,transparent 1px,transparent calc(var(--unit)));border-radius:6px}
  .legend{color:var(--muted);font-size:12px;margin-top:6px}

  /* Device */
  .device{position:absolute;left:18px;right:18px;min-height:var(--unit);background:linear-gradient(180deg,#25306a,#1b2453);border:1px solid #3a4477;border-left:10px solid var(--color,#7aa2ff);border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,.25);color:#eef2ff;display:flex;align-items:center;justify-content:space-between;padding:6px 10px;cursor:grab;user-select:none}
  .device.grabbing{cursor:grabbing;opacity:.95}
  .label{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
  .meta{font-size:11px;color:#c6ccff;opacity:.85;margin-left:8px}
  .actions{display:flex;gap:6px}
  .chip{font-size:11px;background:#0f1330;color:#cbd2ff;border:1px solid #2a2f55;padding:4px 6px;border-radius:999px}
  .iconbtn{background:#0f1330;border:1px solid #2a2f55;width:26px;height:26px;border-radius:8px;display:grid;place-items:center;cursor:pointer}
  .iconbtn:hover{background:#1a2150}
  .ghost{position:absolute;left:0;right:0;height:var(--unit);border:1px dashed var(--accent);pointer-events:none;opacity:.7}
  .ghost.bad{border-color:var(--bad)}

  .preset-pill{padding:6px 8px;border-radius:999px;border:1px solid #2a2f55;background:#0f1330;cursor:pointer}
  .preset-pill:hover{background:#1a2150}
  .preset-color{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;vertical-align:middle}
</style>
</head>
<body>
<header>
  <h1>Rack Planner</h1>
  <div class="controls">
    <!-- Rack chooser -->
    <div class="group racks-bar">
      <label>Rack</label>
      <select id="rackSelect"></select>
      <button class="secondary" id="addRack">Add rack</button>
      <button class="secondary" id="renameRack">Rename</button>
      <button class="danger" id="deleteRack">Delete</button>
      <span class="rack-title" id="rackName"></span>
    </div>

    <!-- Rack settings -->
    <div class="group">
      <label for="rackU">Height</label>
      <input id="rackU" type="number" min="4" max="60" value="42" />
      <label for="unitPx">U size</label>
      <select id="unitPx">
        <option value="18">18px</option>
        <option value="20">20px</option>
        <option value="22" selected>22px</option>
        <option value="24">24px</option>
        <option value="28">28px</option>
      </select>
    </div>

    <!-- Presets / Add device -->
    <div class="group">
      <label>Preset</label>
      <select id="presetSelect"></select>
      <label>Label</label>
      <input id="devLabel" type="text" placeholder="Custom label (optional)" />
      <button id="addPreset">Add preset</button>
    </div>

    <!-- Export/Import -->
    <div class="group">
      <button class="secondary" id="exportJson">Export JSON</button>
      <button class="secondary" id="importJson">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button class="secondary" id="exportPng">Export PNG</button>
      <button class="danger" id="clearAll">Clear rack</button>
    </div>
  </div>
</header>

<main>
  <section class="panel stack">
    <strong>Manufacturer faceplate presets</strong>
    <div class="row" id="presetChips"></div>
    <div class="hr"></div>
    <div class="notice">Drag modules; they snap per‑U. Double‑click the label to edit inline. Right‑click to delete. Overlaps are blocked. U1 is at the <em>bottom</em>.</div>
  </section>

  <section class="rack-wrap">
    <div class="u-scale" id="uScale"></div>
    <div class="rack" id="rack">
      <div class="grid"></div>
      <div class="ghost" id="ghost" hidden></div>
    </div>
  </section>

  <section class="panel stack">
    <strong>State (active rack)</strong>
    <pre id="schemaPreview" style="background:#0c1030;border:1px solid #2a2f55;padding:10px;border-radius:10px;max-height:240px;overflow:auto"></pre>
  </section>
</main>

<script>
(()=>{
  // --- Preset Library (simple faceplate colors & labels) ---
  const PRESETS = [
    { id:'dell-r740', vendor:'Dell', model:'PowerEdge R740', height:2, color:'#4aa3ff' },
    { id:'hp-dl380', vendor:'HPE', model:'ProLiant DL380', height:2, color:'#7bd389' },
    { id:'lenovo-sr650', vendor:'Lenovo', model:'ThinkSystem SR650', height:2, color:'#ff9d5c' },
    { id:'ubnt-usw-24', vendor:'Ubiquiti', model:'USW‑24', height:1, color:'#a6b7ff' },
    { id:'cisco-2960x', vendor:'Cisco', model:'Catalyst 2960‑X', height:1, color:'#5cc0a6' },
    { id:'mikrotik-ccr', vendor:'MikroTik', model:'CCR1036', height:1, color:'#c98bff' },
    { id:'apc-sua2200', vendor:'APC', model:'Smart‑UPS 2200', height:2, color:'#ff6b6b' },
    { id:'patch-24', vendor:'Generic', model:'Patch Panel 24p', height:1, color:'#eab308' },
    { id:'blank-1u', vendor:'Generic', model:'Blank Panel', height:1, color:'#94a3b8' }
  ];

  // --- DOM ---
  const rackEl = document.getElementById('rack');
  const uScaleEl = document.getElementById('uScale');
  const ghostEl = document.getElementById('ghost');

  const rackSelect = document.getElementById('rackSelect');
  const rackNameEl = document.getElementById('rackName');
  const addRackBtn = document.getElementById('addRack');
  const renameRackBtn = document.getElementById('renameRack');
  const deleteRackBtn = document.getElementById('deleteRack');

  const inpRackU = document.getElementById('rackU');
  const selUnit = document.getElementById('unitPx');

  const presetSelect = document.getElementById('presetSelect');
  const presetChips = document.getElementById('presetChips');
  const inpLabel = document.getElementById('devLabel');
  const addPresetBtn = document.getElementById('addPreset');

  const exportJsonBtn = document.getElementById('exportJson');
  const importJsonBtn = document.getElementById('importJson');
  const importFile = document.getElementById('importFile');
  const exportPngBtn = document.getElementById('exportPng');
  const clearBtn = document.getElementById('clearAll');

  const schemaPreview = document.getElementById('schemaPreview');

  // --- State ---
  const STORAGE_KEY = 'rackPlanner.multi.v1';
  let state = {
    racks: [ newRack('Rack A', 42, 22) ],
    activeRackId: null
  };
  state.activeRackId = state.racks[0].id;

  function newRack(name, rackU=42, unitPx=22){
    return { id: 'rack_' + Math.random().toString(36).slice(2,9), name, rackU, unitPx, devices: [] };
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateSchemaPreview(); }
  function load(){ try{ const s=localStorage.getItem(STORAGE_KEY); if(!s) return; const d=JSON.parse(s); if(d && Array.isArray(d.racks)){ state=d; }}catch(e){} }
  function activeRack(){ return state.racks.find(r=>r.id===state.activeRackId) || state.racks[0]; }

  // --- Helpers (U conversions) ---
  function getTopFromU(rack, u, height){ const topIndex = rack.rackU - (u + height) + 1; return Math.round(topIndex * rack.unitPx); }
  function getUFromTop(rack, topPx, height){ const topIndex = Math.round(topPx / rack.unitPx); let u = rack.rackU - topIndex - height + 1; if(u<1) u=1; if(u>rack.rackU - height + 1) u = rack.rackU - height + 1; return u; }
  function occupiedRange(d){ return [d.u, d.u + d.height - 1]; }
  function rangesOverlap(a,b){ return a[0] <= b[1] && b[0] <= a[1]; }
  function anyOverlap(rack, u, height, exceptId=null){ const r=[u,u+height-1]; return rack.devices.some(d=>d.id!==exceptId && rangesOverlap(r, occupiedRange(d))); }
  function firstFit(rack, height){ for(let u=1; u<=rack.rackU-height+1; u++){ if(!anyOverlap(rack, u, height)) return u; } return null; }

  // --- UI rebuild ---
  function rebuildSelectors(){
    rackSelect.innerHTML = '';
    state.racks.forEach(r=>{ const opt=document.createElement('option'); opt.value=r.id; opt.textContent=r.name; rackSelect.appendChild(opt); });
    rackSelect.value = activeRack().id;
    rackNameEl.textContent = activeRack().name;
  }
  function buildUScale(rack){
    uScaleEl.innerHTML='';
    const h = rack.unitPx * rack.rackU; uScaleEl.style.height = h + 'px';
    for(let i=1;i<=rack.rackU;i++){ const tick=document.createElement('div'); tick.className='tick'; tick.style.top = (rack.rackU - i)*rack.unitPx + 'px'; tick.textContent='U'+i; uScaleEl.appendChild(tick); }
  }
  function buildRackBox(rack){ rackEl.style.setProperty('--rackU', rack.rackU); rackEl.style.setProperty('--unit', rack.unitPx + 'px'); rackEl.style.height = (rack.unitPx * rack.rackU) + 'px'; }

  function createDeviceElement(rack, dev){
    const el = document.createElement('div'); el.className='device'; el.dataset.id=dev.id; el.style.setProperty('--color', dev.color); el.style.top = getTopFromU(rack, dev.u, dev.height) + 'px'; el.style.height = (dev.height * rack.unitPx - 2) + 'px';

    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const label = document.createElement('div'); label.className='label'; label.title=dev.label; label.textContent = dev.label || '—';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${dev.height}U • U${dev.u}–U${dev.u+dev.height-1}`;
    left.appendChild(label); left.appendChild(meta);

    const actions = document.createElement('div'); actions.className='actions';
    const chip = document.createElement('div'); chip.className='chip'; chip.textContent = dev.preset || dev.id.replace('dev_','#');
    const editBtn = document.createElement('div'); editBtn.className='iconbtn'; editBtn.title='Rename'; editBtn.innerHTML=pencilSvg;
    const delBtn = document.createElement('div'); delBtn.className='iconbtn'; delBtn.title='Delete'; delBtn.innerHTML=trashSvg;
    actions.appendChild(chip); actions.appendChild(editBtn); actions.appendChild(delBtn);

    el.appendChild(left); el.appendChild(actions);

    // Inline rename – reliable dblclick editing
    function beginInlineEdit(){
      const old = dev.label || '';
      const input = document.createElement('input'); input.type='text'; input.value=old; input.style.fontSize='13px'; input.style.fontWeight='700'; input.style.maxWidth='230px';
      label.replaceWith(input); input.focus(); input.select();
      const finish=(commit)=>{ const val=commit?input.value.trim():old; dev.label=val; save(); render(); };
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){finish(true)} else if(e.key==='Escape'){finish(false)} });
      input.addEventListener('blur', ()=>finish(true));
    }
    label.addEventListener('dblclick', (e)=>{ e.stopPropagation(); beginInlineEdit(); });
    editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); beginInlineEdit(); });

    // Delete
    function deleteDevice(){ if(!confirm('Delete this device?')) return; rack.devices = rack.devices.filter(d=>d.id!==dev.id); save(); render(); }
    delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); deleteDevice(); });
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); deleteDevice(); });

    // Dragging (snap per-U, block overlaps)
    makeDraggable(el, rack, dev);
    return el;
  }

  function render(){
    const rack = activeRack();
    buildUScale(rack); buildRackBox(rack);
    [...rackEl.querySelectorAll('.device')].forEach(n=>n.remove());
    rack.devices.sort((a,b)=>a.u-b.u);
    rack.devices.forEach(dev=>{ rackEl.appendChild(createDeviceElement(rack, dev)); });
    updateSchemaPreview();
  }

  function addDeviceFromPreset(presetId, customLabel){
    const rack = activeRack();
    const p = PRESETS.find(x=>x.id===presetId); if(!p) return;
    const h = p.height||1; let placeU = firstFit(rack, h);
    if(placeU==null){ alert('No space available for a '+h+'U device on '+rack.name); return; }
    const dev = { id:'dev_'+Math.random().toString(36).slice(2,9), label:(customLabel||`${p.vendor} ${p.model}`), u:placeU, height:h, color:p.color, preset:p.id };
    rack.devices.push(dev); save(); render();
  }

  function clearRack(){ const rack=activeRack(); if(!confirm('Clear all devices on '+rack.name+'?')) return; rack.devices=[]; save(); render(); }

  function download(name, text, mime='application/json'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:mime})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000); }

  function exportJSON(){ download(`rack-layout-${new Date().toISOString().replace(/[:.]/g,'-')}.json`, JSON.stringify(state,null,2)); }

  function importJSONFile(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data || !Array.isArray(data.racks)) throw new Error('Invalid file'); state=data; if(!state.activeRackId || !state.racks.find(r=>r.id===state.activeRackId)) state.activeRackId = state.racks[0].id; rebuildSelectors(); save(); render(); }catch(e){ alert('Import failed: '+e.message); } }; reader.readAsText(file); }

  // Export PNG of active rack
  function exportPNG(){
    const rack = activeRack();
    const innerLeft=18, innerRight=18, innerTop=16, innerBottom=16;
    const width = parseInt(getComputedStyle(rackEl).getPropertyValue('--rack-width')) || 360;
    const totalWidth = width + innerLeft + innerRight + 42; // extra for U ruler
    const totalHeight = rack.rackU * rack.unitPx + innerTop + innerBottom;

    const canvas=document.createElement('canvas'); canvas.width=totalWidth*2; canvas.height=totalHeight*2; const ctx=canvas.getContext('2d'); ctx.scale(2,2);
    ctx.fillStyle='#0a0e25'; ctx.fillRect(0,0,totalWidth,totalHeight);
    ctx.strokeStyle='#2a2f55'; ctx.lineWidth=2; ctx.strokeRect(1,1,totalWidth-2,totalHeight-2);

    // U ruler
    ctx.fillStyle='#aab3e6'; ctx.font='11px sans-serif'; ctx.textAlign='right'; ctx.textBaseline='middle';
    for(let i=1;i<=rack.rackU;i++){ const y = innerTop + (rack.rackU - i + .5)*rack.unitPx; ctx.fillText('U'+i, innerLeft-8, y); }

    // Grid
    ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1;
    for(let i=0;i<=rack.rackU;i++){ const y = innerTop + i*rack.unitPx; ctx.beginPath(); ctx.moveTo(innerLeft, y); ctx.lineTo(totalWidth-innerRight, y); ctx.stroke(); }

    // Title
    ctx.fillStyle='#cbd2ff'; ctx.font='bold 14px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(rack.name, innerLeft, 4);

    // Devices
    rack.devices.forEach(d=>{
      const top = innerTop + getTopFromU(rack, d.u, d.height);
      const h = d.height * rack.unitPx - 2;
      const left = innerLeft + 0.5, right = totalWidth - innerRight - 0.5;
      ctx.fillStyle='#1b2453'; ctx.strokeStyle='#3a4477'; ctx.fillRect(left, top, right-left, h); ctx.strokeRect(left, top, right-left, h);
      ctx.fillStyle=d.color || '#7aa2ff'; ctx.fillRect(left, top, 10, h);
      ctx.fillStyle='#eef2ff'; ctx.font='bold 13px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(d.label||'', left+16, top+4);
      ctx.fillStyle='#c6ccff'; ctx.font='11px sans-serif'; ctx.fillText(`${d.height}U • U${d.u}-U${d.u+d.height-1}`, left+16, top+20);
      if(d.preset){ ctx.fillStyle='#aab3e6'; ctx.font='10px sans-serif'; ctx.fillText(`#${d.preset}`, left+16, top+h-14); }
    });

    download(`rack-${rack.name.replace(/[^a-z0-9]+/gi,'_')}-${new Date().toISOString().replace(/[:.]/g,'-')}.png`, canvas.toDataURL('image/png'), 'image/png');
  }

  // Drag logic
  function makeDraggable(el, rack, dev){
    let startY=0, startTop=0, dragging=false;
    const onDown=(e)=>{
      // Avoid starting a drag when user intends to edit (dblclick on label)
      if(e.target && (e.target.classList.contains('label') || e.target.closest('.iconbtn'))){ return; }
      dragging=true; el.classList.add('grabbing');
      startY = (e.touches?e.touches[0].clientY:e.clientY); startTop=parseInt(el.style.top,10)||0;
      showGhostAt(rack, dev.u, dev.height);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp, {once:true});
      window.addEventListener('touchend', onUp, {once:true});
    };
    const onMove=(e)=>{
      if(!dragging) return; const y=(e.touches?e.touches[0].clientY:e.clientY); const dy=y-startY; const rackRect=rackEl.getBoundingClientRect(); let nextTop=startTop+dy;
      const minTop=0, maxTop=rackRect.height - dev.height * rack.unitPx; nextTop=Math.max(minTop, Math.min(maxTop, nextTop)); el.style.top = nextTop + 'px';
      const trialU = getUFromTop(rack, nextTop, dev.height); const bad = anyOverlap(rack, trialU, dev.height, dev.id);
      moveGhostToU(rack, trialU, dev.height, bad); ghostEl.hidden=false; ghostEl.classList.toggle('bad', !!bad); e.preventDefault();
    };
    const onUp=()=>{
      dragging=false; el.classList.remove('grabbing'); ghostEl.hidden=true; ghostEl.classList.remove('bad');
      const topPx=parseInt(el.style.top,10)||0; let trialU = getUFromTop(rack, topPx, dev.height);
      if(anyOverlap(rack, trialU, dev.height, dev.id)){ el.style.top = getTopFromU(rack, dev.u, dev.height) + 'px'; flash(el); return; }
      dev.u = trialU; save(); render();
    };
    el.addEventListener('mousedown', onDown); el.addEventListener('touchstart', onDown, {passive:true});
  }
  function showGhostAt(rack, u, height){ const top = getTopFromU(rack, u, height); ghostEl.style.top=(top+16)+'px'; ghostEl.style.left='14px'; ghostEl.style.right='14px'; ghostEl.style.height=(height*rack.unitPx-2)+'px'; ghostEl.hidden=false; }
  function moveGhostToU(rack, u, height, bad){ showGhostAt(rack, u, height); ghostEl.classList.toggle('bad', !!bad); }
  function flash(el){ el.animate([{filter:'brightness(1)'},{filter:'brightness(1.8)'},{filter:'brightness(1)'}],{duration:300}); }

  // Build preset UI
  function buildPresets(){
    // dropdown
    presetSelect.innerHTML = '';
    PRESETS.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=`${p.vendor} ${p.model} (${p.height}U)`; presetSelect.appendChild(opt); });
    // chips
    presetChips.innerHTML='';
    PRESETS.forEach(p=>{ const btn=document.createElement('button'); btn.className='preset-pill'; btn.innerHTML=`<span class="preset-color" style="background:${p.color}"></span>${p.vendor} ${p.model} <small>(${p.height}U)</small>`; btn.addEventListener('click',()=> addDeviceFromPreset(p.id, null)); presetChips.appendChild(btn); });
  }

  // Update state preview (only active rack to keep short)
  function updateSchemaPreview(){ const rack=activeRack(); const view={rack, allRackNames: state.racks.map(r=>r.name)}; schemaPreview.textContent = JSON.stringify(view,null,2); }

  // Wire rack controls
  addRackBtn.addEventListener('click', ()=>{ const name=prompt('New rack name?','Rack '+String.fromCharCode(65+state.racks.length)); if(!name) return; const r=newRack(name.trim(), 42, 22); state.racks.push(r); state.activeRackId=r.id; rebuildSelectors(); save(); render(); });
  renameRackBtn.addEventListener('click', ()=>{ const r=activeRack(); const next=prompt('Rename rack:', r.name); if(next==null) return; r.name=next.trim()||r.name; rebuildSelectors(); save(); render(); });
  deleteRackBtn.addEventListener('click', ()=>{ if(state.racks.length<=1){ alert('You must have at least one rack.'); return; } const r=activeRack(); if(!confirm('Delete '+r.name+'?')) return; state.racks = state.racks.filter(x=>x.id!==r.id); state.activeRackId = state.racks[0].id; rebuildSelectors(); save(); render(); });
  rackSelect.addEventListener('change', ()=>{ state.activeRackId = rackSelect.value; rebuildSelectors(); save(); render(); });

  // Rack settings
  inpRackU.addEventListener('change', ()=>{ const r=activeRack(); const next=Math.max(4, Math.min(60, parseInt(inpRackU.value,10)||r.rackU)); r.rackU=next; r.devices = r.devices.filter(d=> d.u + d.height - 1 <= next); save(); render(); });
  selUnit.addEventListener('change', ()=>{ const r=activeRack(); r.unitPx = Math.max(14, Math.min(40, parseInt(selUnit.value,10)||r.unitPx)); save(); render(); });

  // Preset add
  addPresetBtn.addEventListener('click', ()=>{ addDeviceFromPreset(presetSelect.value, inpLabel.value.trim()||null); inpLabel.value=''; });

  // Export/Import
  exportJsonBtn.addEventListener('click', exportJSON);
  importJsonBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', ()=>{ const f=importFile.files[0]; if(f) importJSONFile(f); importFile.value=''; });
  exportPngBtn.addEventListener('click', exportPNG);
  clearBtn.addEventListener('click', clearRack);

  // Icons
  const pencilSvg='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#cbd2ff"/><path d="M20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#cbd2ff"/></svg>';
  const trashSvg='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ffb3b3"/></svg>';
  window.pencilSvg=pencilSvg; window.trashSvg=trashSvg;

  // Init
  load();
  if(!state || !Array.isArray(state.racks) || state.racks.length===0){ state={racks:[newRack('Rack A',42,22)], activeRackId:null}; state.activeRackId=state.racks[0].id; }
  rebuildSelectors();
  inpRackU.value = activeRack().rackU; selUnit.value = activeRack().unitPx;
  buildPresets();
  render();
})();
</script>
</body>
</html>
