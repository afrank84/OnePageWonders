<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RustDesk Address Book</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<style>
  html,body{height:100%}
  body{margin:0}
  .toolbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #dee2e6}
  .table thead th{position:sticky;top:112px;background:#fff;z-index:5}
  @media (max-width: 768px){ .table thead th{top:164px} }
  .list-wrap{max-height:calc(100vh - 180px);overflow:auto;border:1px solid #e9ecef;border-radius:.5rem}
  .tag-pill{border:1px solid #ced4da;border-radius:999px;padding:.1rem .5rem;font-size:.8rem}
</style>
</head>
<body>

<!-- Top toolbar -->
<div class="toolbar">
  <div class="container-fluid py-2">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <div class="me-auto">
        <span class="h5 mb-0">RustDesk Address Book</span>
      </div>

      <div class="input-group" style="max-width:360px">
        <span class="input-group-text">Search</span>
        <input id="searchBox" class="form-control" placeholder="name / id / tag / notes" />
        <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
      </div>

      <select id="tagFilter" class="form-select form-select-sm" style="width:auto">
        <option value="">All tags</option>
      </select>

      <select id="sortBy" class="form-select form-select-sm" style="width:auto">
        <option value="name">Sort: Name</option>
        <option value="id">Sort: ID</option>
        <option value="tag">Sort: Tag</option>
        <option value="updated">Sort: Recently Updated</option>
      </select>

      <button id="importBtn" class="btn btn-outline-secondary btn-sm">Import</button>
      <button id="exportBtn" class="btn btn-outline-secondary btn-sm">Export</button>
      <button id="addBtn" class="btn btn-primary btn-sm">Add</button>
    </div>

    <div class="small text-muted mt-2">
      Entries: <span id="count">0</span> • “Open App” uses <code>rustdesk://&lt;id&gt;</code>
    </div>
  </div>
</div>

<!-- List -->
<div class="container-fluid py-3">
  <div class="list-wrap">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th style="width:30%">Name</th>
          <th style="width:22%">ID</th>
          <th style="width:18%">Tag</th>
          <th style="width:30%" class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Add/Edit modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editTitle" class="modal-title">Add Computer</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="vstack gap-3">
          <div>
            <label class="form-label">Name</label>
            <input id="f_name" class="form-control" required />
          </div>
          <div>
            <label class="form-label">RustDesk ID</label>
            <input id="f_id" class="form-control" required />
          </div>
          <div>
            <label class="form-label">Tag (optional)</label>
            <input id="f_tag" class="form-control" placeholder="Home, Office, Lab…" />
          </div>
          <div>
            <label class="form-label">Notes (optional)</label>
            <textarea id="f_notes" class="form-control" rows="2"></textarea>
          </div>
          <input id="f_internal" type="hidden" />
        </form>
      </div>
      <div class="modal-footer">
        <button id="deleteBtn" class="btn btn-outline-danger me-auto" style="display:none">Delete</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<input id="fileImport" type="file" accept="application/json" hidden />

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>

<script>
/* ===== Storage ===== */
const LS_KEY = 'rd_address_book_simple_v1';
const load = () => { try { const d = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); return Array.isArray(d)?d:[]; } catch { return []; } };
const save = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

/* ===== State ===== */
let items = load();
let search = '';
let sortBy = 'name';
let tagFilter = '';

/* ===== Elements ===== */
const rowsEl = document.getElementById('rows');
const countEl = document.getElementById('count');
const searchBox = document.getElementById('searchBox');
const clearBtn = document.getElementById('clearBtn');
const sortSel = document.getElementById('sortBy');
const tagSel  = document.getElementById('tagFilter');
const addBtn = document.getElementById('addBtn');
const importBtn = document.getElementById('importBtn');
const exportBtn = document.getElementById('exportBtn');
const fileImport = document.getElementById('fileImport');

/* Modal fields */
const m = new bootstrap.Modal(document.getElementById('editModal'));
const editTitle = document.getElementById('editTitle');
const f_name = document.getElementById('f_name');
const f_id = document.getElementById('f_id');
const f_tag = document.getElementById('f_tag');
const f_notes = document.getElementById('f_notes');
const f_internal = document.getElementById('f_internal');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');

/* ===== Utils ===== */
const uid = () => 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const esc = (s) => (s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function toast(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.className = 'position-fixed start-50 translate-middle-x bottom-0 mb-3 px-3 py-2 rounded border bg-white shadow';
  el.style.zIndex = 2000;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 1200);
}

/* ===== Render ===== */
function rebuildTagFilter(){
  const tags = Array.from(new Set(items.map(x => (x.tag||'').trim()).filter(Boolean))).sort();
  tagSel.innerHTML = '<option value="">All tags</option>' + tags.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
  tagSel.value = tagFilter;
}

function render(){
  const q = search.trim().toLowerCase();
  let list = items.filter(x=>{
    const hay = [x.name,x.id,x.tag,x.notes].map(v=>(v||'').toLowerCase()).join(' ');
    const passesSearch = hay.includes(q);
    const passesTag = !tagFilter || (x.tag||'') === tagFilter;
    return passesSearch && passesTag;
  });

  list.sort((a,b)=>{
    if (sortBy==='updated') return (b.updatedAt||0)-(a.updatedAt||0);
    const av=(a[sortBy]||'').toString().toLowerCase();
    const bv=(b[sortBy]||'').toString().toLowerCase();
    return av.localeCompare(bv);
  });

  rowsEl.innerHTML = '';
  for(const it of list){
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    tdName.innerHTML = `<div class="fw-semibold">${esc(it.name||'')}</div>
                        <div class="small text-muted">${esc(it.notes||'')}</div>`;
    tr.appendChild(tdName);

    const tdId = document.createElement('td');
    tdId.innerHTML = `<code>${esc(it.id||'')}</code>`;
    tr.appendChild(tdId);

    const tdTag = document.createElement('td');
    tdTag.innerHTML = it.tag ? `<span class="tag-pill">${esc(it.tag)}</span>` : '<span class="text-muted">—</span>';
    tr.appendChild(tdTag);

    const tdActions = document.createElement('td');
    tdActions.className = 'text-center';
    tdActions.innerHTML = `
      <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-primary">Open App</button>
        <button class="btn btn-outline-secondary">Copy ID</button>
        <button class="btn btn-outline-dark">Edit</button>
      </div>`;
    const [btnApp, btnCopy, btnEdit] = tdActions.querySelectorAll('button');
    btnApp.addEventListener('click', ()=> openApp(it.id));
    btnCopy.addEventListener('click', ()=> copyToClipboard(it.id));
    btnEdit.addEventListener('click', ()=> openEdit(it.id_internal));
    tr.appendChild(tdActions);

    rowsEl.appendChild(tr);
  }

  countEl.textContent = list.length;
  rebuildTagFilter();
}

/* ===== Actions ===== */
function openApp(id){
  if(!id) return;
  location.href = 'rustdesk://' + encodeURIComponent(id);
}
function copyToClipboard(text){
  if(!text) return;
  navigator.clipboard?.writeText(text).then(()=> toast('ID copied')).catch(()=> alert('Copy failed'));
}

/* ===== Add/Edit/Delete ===== */
function clearForm(){
  f_name.value=''; f_id.value=''; f_tag.value=''; f_notes.value=''; f_internal.value='';
}
function openAdd(){
  clearForm();
  editTitle.textContent = 'Add Computer';
  deleteBtn.style.display='none';
  m.show();
}
function openEdit(internalId){
  const it = items.find(x=> x.id_internal===internalId);
  if(!it) return;
  f_name.value = it.name||'';
  f_id.value = it.id||'';
  f_tag.value = it.tag||'';
  f_notes.value = it.notes||'';
  f_internal.value = it.id_internal;
  editTitle.textContent = 'Edit Computer';
  deleteBtn.style.display='inline-block';
  m.show();
}
saveBtn.addEventListener('click', ()=>{
  const name = f_name.value.trim();
  const id = f_id.value.trim();
  if(!name || !id){ alert('Name and RustDesk ID are required.'); return; }
  const now = Date.now();
  const payload = { name, id, tag:f_tag.value.trim(), notes:f_notes.value.trim(), updatedAt: now };

  if(f_internal.value){
    const i = items.findIndex(x=> x.id_internal===f_internal.value);
    if(i>=0) items[i] = Object.assign({}, items[i], payload);
  }else{
    items.push(Object.assign({ id_internal: uid(), createdAt: now }, payload));
  }
  save(items); m.hide(); render();
});
deleteBtn.addEventListener('click', ()=>{
  if(!confirm('Delete this entry?')) return;
  const idInt = f_internal.value;
  items = items.filter(x=> x.id_internal !== idInt);
  save(items); m.hide(); render();
});

/* ===== Import/Export ===== */
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(items,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='rustdesk-address-book.json'; a.click();
  URL.revokeObjectURL(url);
});
importBtn.addEventListener('click', ()=> fileImport.click());
fileImport.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Invalid JSON (expected an array).');
    // normalize & merge by id_internal
    const incoming = arr.map(x=> ({
      id_internal: x.id_internal || uid(),
      name: x.name || '',
      id: x.id || '',
      tag: x.tag || '',
      notes: x.notes || '',
      createdAt: x.createdAt || Date.now(),
      updatedAt: x.updatedAt || Date.now()
    }));
    const map = new Map(items.map(x=> [x.id_internal, x]));
    for(const it of incoming) map.set(it.id_internal, it);
    items = Array.from(map.values());
    save(items);
    toast('Import complete');
    render();
  }catch(err){
    alert('Import failed: ' + err.message);
  }finally{
    e.target.value = '';
  }
});

/* ===== Filters / Controls ===== */
searchBox.addEventListener('input', e=> { search = e.target.value; render(); });
clearBtn.addEventListener('click', ()=> { searchBox.value=''; search=''; render(); });
sortSel.addEventListener('change', e=> { sortBy = e.target.value; render(); });
tagSel.addEventListener('change', e=> { tagFilter = e.target.value; render(); });
addBtn.addEventListener('click', openAdd);

/* ===== Demo data on first run ===== */
(function ensureDemo(){
  if(items.length===0){
    items = [
      { id_internal: uid(), name:'Lab NUC', id:'ABCD-9876', tag:'Lab', notes:'Ubuntu host', createdAt:Date.now(), updatedAt:Date.now() },
      { id_internal: uid(), name:'Office Desktop', id:'123-456-789', tag:'Office', notes:'Main workstation', createdAt:Date.now(), updatedAt:Date.now() }
    ];
    save(items);
  }
})();

render();
</script>
</body>
</html>
